<?php

namespace Dollie\Core\Shortcodes;

if ( ! defined( 'ABSPATH' ) ) {
	exit; // Exit if accessed directly.
}

use Dollie\Core\Singleton;
use WP_Query;

/**
 * Class Sites
 *
 * @package Dollie\Core\Shortcodes
 */
final class SiteStats extends Singleton implements Base {

	private string $name = 'dollie-site-stats';

	private $labels;
	private $containers = [
		'app',
		'db'
	];
	private $keys = [
		'block'      => [ 'read', 'write' ],
		'cpu'        => [ 'usage' ],
		'disk_usage' => [ 'usage' ],
		'memory'     => [ 'usage', /*'mem_assigned', 'mem_hardlimit'*/ ],
		'network'    => [ 'in', 'out' ],
	];

	/**
	 * Sites constructor.
	 */
	public function __construct() {
		parent::__construct();

		$this->labels = [
			'block'      => __( 'Disk I/O', 'dollie' ),
			'cpu'        => __( 'CPU %', 'dollie' ),
			'disk_usage' => __( 'Disk', 'dollie' ),
			'memory'     => __( 'Memory', 'dollie' ),
			'network'    => __( 'Network', 'dollie' ),
		];

		add_action( 'init', [ $this, 'register' ] );
		add_action( 'wp_enqueue_scripts', [ $this, 'enqueue' ]
		);
	}

	public function enqueue() {
		wp_register_script( 'chartjs', DOLLIE_ASSETS_URL . 'js/chart.min.js', [], '4.1.1', true );
	}

	/**
	 * Add shortcode
	 *
	 * @return void
	 */
	public function register(): void {
		add_shortcode( $this->name, [ $this, 'shortcode' ] );
	}

	/**
	 * Shortcode logic
	 *
	 * @param array $atts
	 *
	 * @return string|null
	 */
	public function shortcode( $atts = [] ): ?string {

		$settings = shortcode_atts(
			[
				'id'        => dollie()->get_current_post_id(),
				'container' => 'app', //app|db
				'type'      => 'block'

			],
			$atts,
			$this->name
		);

		$stats = $this->get_data( $settings['id'] );
		if ( empty( $stats ) ) {
			return '';
		}


		[ $labels, $datasets ] = $this->prepare_stats( $stats, $settings['type'] );

		return dollie()->load_template(
			'widgets/site/site-stats',
			[
				'labels'   => json_encode( $labels ),
				'datasets' => json_encode( $datasets ),
				'chart_id' => 'stats-chart-' . random_int(100, 9999)
			]
		);

	}

	/**
	 * Prepare the data format for chartJS.
	 *
	 * @param $stats
	 * @param $type
	 *
	 * @return array
	 */
	private function prepare_stats( $stats, $type ) {
		$labels   = [];
		$datasets = [];

		foreach ( $this->containers as $container ) {
			if ( ! isset( $stats[ $container ] ) ) {
				continue;
			}
			foreach ( $this->keys[ $type ] as $key ) {

				$set = [];

				if ( ! isset( $stats[ $container ]['stats'][ $type ] ) ) {
					continue;
				}

				foreach ( $stats[ $container ]['stats'][ $type ][ $key ] as $time => $val ) {
					$labels[ md5(date( 'Y-m-d H:i', $time )) ] = date( 'j M H:i', $time );
					if ( $stats[ $container ]['stats'][ $type ]['units'] === 'bytes' ) {
						$val = round( $val / 1024 / 1024 );
					}
					$set[] = $val;
				}

				if ( ! empty( $labels ) ) {
					$datasets[] = [
						'label' => strtoupper( $container ) . " " . $this->labels[ $type ] . ' ' . ucfirst( $key ),
						'data'  => $set
					];
				}

			}

		}

		return [ array_values( $labels ), $datasets ];

	}

	/**
	 * Get stats data from API
	 *
	 * @param int|false $site_id
	 *
	 * @return array
	 */
	private function get_data( $site_id = null ): array {

		$data = json_decode( '{
  "site": "ff8081815148ce01015148d21e370003",
  "app": {
    "stats": {
      "block": {
        "read": {
          "1670618807": "382402560",
          "1670619107": "382402560",
          "1670619407": "382402560",
          "1670619707": "382402560",
          "1670620007": "382402560",
          "1670620307": "382402560",
          "1670620607": "382402560",
          "1670620907": "382402560",
          "1670621207": "382402560",
          "1670621507": "382402560",
          "1670621807": "382402560",
          "1670622107": "382402560",
          "1670622407": "382402560"
        },
        "write": {
          "1670618807": "3181387776",
          "1670619107": "3183812608",
          "1670619407": "3186237440",
          "1670619707": "3188662272",
          "1670620007": "3191087104",
          "1670620307": "3193511936",
          "1670620607": "3195936768",
          "1670620907": "3198361600",
          "1670621207": "3200892928",
          "1670621507": "3203317760",
          "1670621807": "3205742592",
          "1670622107": "3208167424",
          "1670622407": "3210592256"
        },
        "units": "bytes"
      },
      "cpu": {
        "usage": {
          "1670618807": "0.12528682464454977",
          "1670619107": "0.1149264077669903",
          "1670619407": "0.1254600716845878",
          "1670619707": "0.1216918192918193",
          "1670620007": "0.12112406287787182",
          "1670620307": "0.148910243902439",
          "1670620607": "0.12912135102533173",
          "1670620907": "0.12135804161566707",
          "1670621207": "0.11670939172749391",
          "1670621507": "0.12654444714459295",
          "1670621807": "0.13542782178217821",
          "1670622107": "0.121798431372549",
          "1670622407": "0.1258521151439299"
        },
        "units": "percentage"
      },
      "disk_usage": {
        "usage": {
          "1670618807": "88787279",
          "1670619107": "88787279",
          "1670619407": "88803663",
          "1670619707": "88803663",
          "1670620007": "88803663",
          "1670620307": "88803663",
          "1670620607": "88787279",
          "1670620907": "88787279",
          "1670621207": "88787279",
          "1670621507": "88787279",
          "1670621807": "88787279",
          "1670622107": "88787279",
          "1670622407": "88787279"
        },
        "units": "bytes"
      },
      "memory": {
        "usage": {
          "1670618807": "351002624",
          "1670619107": "351064064",
          "1670619407": "351019008",
          "1670619707": "351109120",
          "1670620007": "351117312",
          "1670620307": "351121408",
          "1670620607": "351240192",
          "1670620907": "351031296",
          "1670621207": "350756864",
          "1670621507": "350887936",
          "1670621807": "349216768",
          "1670622107": "351350784",
          "1670622407": "351563776"
        },
        "mem_assigned": {
          "1670618807": "536870912",
          "1670619107": "536870912",
          "1670619407": "536870912",
          "1670619707": "536870912",
          "1670620007": "536870912",
          "1670620307": "536870912",
          "1670620607": "536870912",
          "1670620907": "536870912",
          "1670621207": "536870912",
          "1670621507": "536870912",
          "1670621807": "536870912",
          "1670622107": "536870912",
          "1670622407": "536870912"
        },
        "mem_hardlimit": {
          "1670618807": "1610612736",
          "1670619107": "1610612736",
          "1670619407": "1610612736",
          "1670619707": "1610612736",
          "1670620007": "1610612736",
          "1670620307": "1610612736",
          "1670620607": "1610612736",
          "1670620907": "1610612736",
          "1670621207": "1610612736",
          "1670621507": "1610612736",
          "1670621807": "1610612736",
          "1670622107": "1610612736",
          "1670622407": "1610612736"
        },
        "units": "bytes"
      },
      "network": {
        "in": {
          "1670618807": "342220442",
          "1670619107": "342312598",
          "1670619407": "342403210",
          "1670619707": "342495702",
          "1670620007": "342586278",
          "1670620307": "342678578",
          "1670620607": "342769190",
          "1670620907": "342861382",
          "1670621207": "343074900",
          "1670621507": "343166960",
          "1670621807": "343324276",
          "1670622107": "343416336",
          "1670622407": "343509176"
        },
        "out": {
          "1670618807": "212853354",
          "1670619107": "212971836",
          "1670619407": "213088156",
          "1670619707": "213206446",
          "1670620007": "213322334",
          "1670620307": "213440456",
          "1670620607": "213556644",
          "1670620907": "213675030",
          "1670621207": "213809096",
          "1670621507": "213927482",
          "1670621807": "214067970",
          "1670622107": "214186092",
          "1670622407": "214323642"
        },
        "units": "bytes"
      }
    }
  },
  "db": {
    "stats": {
      "block": {
        "read": {
          "1670618807": "30597120",
          "1670619107": "30597120",
          "1670619407": "30597120",
          "1670619707": "30597120",
          "1670620007": "30597120",
          "1670620307": "30597120",
          "1670620607": "30597120",
          "1670620907": "30597120",
          "1670621207": "30597120",
          "1670621507": "30597120",
          "1670621807": "30597120",
          "1670622107": "30597120",
          "1670622407": "30597120"
        },
        "write": {
          "1670618807": "5459230720",
          "1670619107": "5466759168",
          "1670619407": "5469560832",
          "1670619707": "5472362496",
          "1670620007": "5480202240",
          "1670620307": "5482790912",
          "1670620607": "5484732416",
          "1670620907": "5492867072",
          "1670621207": "5494833152",
          "1670621507": "5501919232",
          "1670621807": "5505343488",
          "1670622107": "5507325952",
          "1670622407": "5514952704"
        },
        "units": "bytes"
      },
      "cpu": {
        "usage": {
          "1670618807": "0.06706747868453106",
          "1670619107": "0.06574007290400972",
          "1670619407": "0.06627230769230769",
          "1670619707": "0.062275961538461544",
          "1670620007": "0.06398153098420413",
          "1670620307": "0.06362023640661939",
          "1670620607": "0.05836019417475728",
          "1670620907": "0.06357241038318913",
          "1670621207": "0.05994469483568075",
          "1670621507": "0.07083756097560975",
          "1670621807": "0.06936573476702508",
          "1670622107": "0.07281588235294117",
          "1670622407": "0.06312937198067632"
        },
        "units": "percentage"
      },
      "disk_usage": null,
      "memory": {
        "usage": {
          "1670618807": "85970944",
          "1670619107": "86003712",
          "1670619407": "86036480",
          "1670619707": "86069248",
          "1670620007": "86093824",
          "1670620307": "85991424",
          "1670620607": "85880832",
          "1670620907": "85913600",
          "1670621207": "85938176",
          "1670621507": "85970944",
          "1670621807": "86028288",
          "1670622107": "86052864",
          "1670622407": "86085632"
        },
        "mem_assigned": {
          "1670618807": "536870912",
          "1670619107": "536870912",
          "1670619407": "536870912",
          "1670619707": "536870912",
          "1670620007": "536870912",
          "1670620307": "536870912",
          "1670620607": "536870912",
          "1670620907": "536870912",
          "1670621207": "536870912",
          "1670621507": "536870912",
          "1670621807": "536870912",
          "1670622107": "536870912",
          "1670622407": "536870912"
        },
        "mem_hardlimit": {
          "1670618807": "1610612736",
          "1670619107": "1610612736",
          "1670619407": "1610612736",
          "1670619707": "1610612736",
          "1670620007": "1610612736",
          "1670620307": "1610612736",
          "1670620607": "1610612736",
          "1670620907": "1610612736",
          "1670621207": "1610612736",
          "1670621507": "1610612736",
          "1670621807": "1610612736",
          "1670622107": "1610612736",
          "1670622407": "1610612736"
        },
        "units": "bytes"
      },
      "network": {
        "in": {
          "1670618807": "93572160",
          "1670619107": "93647732",
          "1670619407": "93721142",
          "1670619707": "93796522",
          "1670620007": "93869500",
          "1670620307": "93944820",
          "1670620607": "94018098",
          "1670620907": "94093574",
          "1670621207": "94184722",
          "1670621507": "94260198",
          "1670621807": "94350096",
          "1670622107": "94425308",
          "1670622407": "94498454"
        },
        "out": {
          "1670618807": "124900930",
          "1670619107": "124989346",
          "1670619407": "125076218",
          "1670619707": "125164970",
          "1670620007": "125251806",
          "1670620307": "125340258",
          "1670620607": "125427130",
          "1670620907": "125515582",
          "1670621207": "125725360",
          "1670621507": "125813680",
          "1670621807": "125951532",
          "1670622107": "126039852",
          "1670622407": "126126988"
        },
        "units": "bytes"
      }
    }
  }}', true );

		//TODO remove dummy data
		return $data;

		if ( empty( $site_id ) ) {
			$site_id = get_the_ID();
		}

		$container = dollie()->get_container( $site_id );
		if ( is_wp_error( $container ) ) {
			return [];
		}

		return $container->get_resource_usage();
	}

}
